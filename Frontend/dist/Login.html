<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevChat - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'purple-custom': '#9661FF',
                    },
                    animation: {
                        'slide-up': 'slideUp 0.6s ease-out',
                        'fade-in': 'fadeIn 0.3s ease',
                        'spin-slow': 'spin 1s ease-in-out infinite',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(30px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #9661FF 0%, #764ba2 100%);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #9661FF, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .gradient-btn {
            background: linear-gradient(135deg, #9661FF, #764ba2);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-5 font-sans">
   
    <div class="glass-effect rounded-2xl shadow-2xl p-10 w-full max-w-md animate-slide-up transition-all duration-300" id="container">
        <div class="text-center mb-8">
            <h1 class="gradient-text text-4xl font-bold mb-2">DevChat</h1>
            <p class="text-gray-600 text-sm" id="subtitle">Welcome back! Please sign in to your account</p>
        </div>

        <div id="alertContainer" class="mb-5"></div>

        <!-- Login Form -->
        <form id="loginForm" class="space-y-5">
            <div class="space-y-2">
                <label for="emailOrUsername" class="block text-gray-700 font-medium text-sm">Email or Username</label>
                <input type="text" id="emailOrUsername" name="emailOrUsername" required 
                       class="w-full p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-white focus:outline-none focus:border-purple-custom focus:shadow-lg focus:shadow-purple-custom/10 focus:-translate-y-0.5">
            </div>

            <div class="space-y-2">
                <label for="loginPassword" class="block text-gray-700 font-medium text-sm">Password</label>
                <input type="password" id="loginPassword" name="password" required 
                       class="w-full p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-white focus:outline-none focus:border-purple-custom focus:shadow-lg focus:shadow-purple-custom/10 focus:-translate-y-0.5">
            </div>

            <div class="flex items-center mb-6">
                <input type="checkbox" id="rememberMe" name="rememberMe" class="mr-3 transform scale-125">
                <label for="rememberMe" class="text-gray-600 text-sm cursor-pointer">Remember me</label>
            </div>

            <button type="submit" class="w-full p-4 gradient-btn text-white border-0 rounded-xl text-base font-semibold cursor-pointer transition-all duration-300 relative overflow-hidden hover:-translate-y-0.5 hover:shadow-xl hover:shadow-purple-custom/30 active:translate-y-0 disabled:opacity-70 disabled:cursor-not-allowed disabled:transform-none">
                <div class="hidden w-5 h-5 border-2 border-white border-opacity-30 rounded-full border-t-white animate-spin-slow mr-2 inline-block" id="loginLoading"></div>
                <span id="loginBtnText">Sign In</span>
            </button>
        </form>

        <!-- Signup Form -->
        <form id="signupForm" class="space-y-5 hidden">
            <div class="space-y-2">
                <label for="signupUsername" class="block text-gray-700 font-medium text-sm">Username</label>
                <input type="text" id="signupUsername" name="username" required 
                       class="w-full p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-white focus:outline-none focus:border-purple-custom focus:shadow-lg focus:shadow-purple-custom/10 focus:-translate-y-0.5">
            </div>

            <div class="space-y-2">
                <label for="signupEmail" class="block text-gray-700 font-medium text-sm">Email</label>
                <input type="email" id="signupEmail" name="email" required 
                       class="w-full p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-white focus:outline-none focus:border-purple-custom focus:shadow-lg focus:shadow-purple-custom/10 focus:-translate-y-0.5">
            </div>

            <div class="space-y-2">
                <label for="signupFullName" class="block text-gray-700 font-medium text-sm">Full Name</label>
                <input type="text" id="signupFullName" name="fullName" required 
                       class="w-full p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-white focus:outline-none focus:border-purple-custom focus:shadow-lg focus:shadow-purple-custom/10 focus:-translate-y-0.5">
            </div>

            <div class="space-y-2">
                <label for="signupPassword" class="block text-gray-700 font-medium text-sm">Password</label>
                <input type="password" id="signupPassword" name="password" required 
                       class="w-full p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-white focus:outline-none focus:border-purple-custom focus:shadow-lg focus:shadow-purple-custom/10 focus:-translate-y-0.5">
            </div>

            <div class="space-y-2">
                <label for="profilePicture" class="block text-gray-700 font-medium text-sm">Profile Picture URL (Optional)</label>
                <input type="url" id="profilePicture" name="profilePicture" placeholder="https://example.com/avatar.jpg"
                       class="w-full p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-white focus:outline-none focus:border-purple-custom focus:shadow-lg focus:shadow-purple-custom/10 focus:-translate-y-0.5">
            </div>

            <button type="submit" class="w-full p-4 gradient-btn text-white border-0 rounded-xl text-base font-semibold cursor-pointer transition-all duration-300 relative overflow-hidden hover:-translate-y-0.5 hover:shadow-xl hover:shadow-purple-custom/30 active:translate-y-0 disabled:opacity-70 disabled:cursor-not-allowed disabled:transform-none">
                <div class="hidden w-5 h-5 border-2 border-white border-opacity-30 rounded-full border-t-white animate-spin-slow mr-2 inline-block" id="signupLoading"></div>
                <span id="signupBtnText">Create Account</span>
            </button>
        </form>

        <div class="text-center my-8 relative text-gray-400 text-sm">
            <div class="absolute top-1/2 left-0 right-0 h-px bg-gray-200"></div>
            <span class="glass-effect px-5 relative z-10" id="dividerText">Already have an account?</span>
        </div>

        <div class="text-center">
            <a href="#" onclick="toggleMode()" class="text-purple-custom no-underline font-medium transition-colors duration-300 hover:text-purple-800 hover:underline" id="switchLink">
                Switch to Login
            </a>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8080/api/auth';
        let isSignupMode = false;

        // DOM Elements
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const alertContainer = document.getElementById('alertContainer');
        const container = document.getElementById('container');
        const subtitle = document.getElementById('subtitle');
        const toggleText = document.getElementById('toggleText');
        const dividerText = document.getElementById('dividerText');
        const switchLink = document.getElementById('switchLink');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            loginForm.addEventListener('submit', handleLogin);
            signupForm.addEventListener('submit', handleSignup);
            
            // Add input validation feedback
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.required && !this.value.trim()) {
                        this.classList.add('border-red-500', 'shadow-red-500/10');
                        this.classList.remove('border-gray-200');
                    } else {
                        this.classList.remove('border-red-500', 'shadow-red-500/10');
                        this.classList.add('border-gray-200');
                    }
                });

                input.addEventListener('input', function() {
                    if (this.classList.contains('border-red-500') && this.value.trim()) {
                        this.classList.remove('border-red-500', 'shadow-red-500/10');
                        this.classList.add('border-gray-200');
                    }
                });
            });
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const loading = document.getElementById('loginLoading');
            const btnText = document.getElementById('loginBtnText');
            
            // Show loading state
            setLoadingState(submitBtn, loading, btnText, true, false);
            clearAlerts();

            const formData = new FormData(e.target);
            const loginData = {
                emailOrUsername: formData.get('emailOrUsername').trim(),
                password: formData.get('password'),
                rememberMe: formData.get('rememberMe') === 'on'
            };

            console.log('Attempting login with data:', { 
                emailOrUsername: loginData.emailOrUsername, 
                rememberMe: loginData.rememberMe 
            });
            console.log('Sending request to:', `${API_BASE_URL}/login`);

            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    credentials: 'include', // Include cookies for CORS
                    body: JSON.stringify(loginData)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);

                const result = await response.text();
                console.log('Response body:', result);

                if (response.ok) {
                    showAlert('Login successful! Welcome back!', 'success');
                    // Store user info if remember me is checked
                    if (loginData.rememberMe) {
                        console.log('Remember me enabled');
                    }
                    // Redirect or update UI as needed
                    setTimeout(() => {
                        console.log('Redirecting to dashboard...');
                        // window.location.href = '/dashboard';
                    }, 1500);
                } else {
                    const errorMessage = result.includes('Error:') ? result : `Error: ${result}`;
                    showAlert(errorMessage || 'Login failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Login error details:', error);
                
                // TODO: make production ready error messages
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showAlert('Cannot connect to server. Please check if the backend is running on http://localhost:8080', 'error');
                } else if (error.message.includes('CORS')) {
                    showAlert('CORS error: Please check your backend CORS configuration.', 'error');
                } else {
                    showAlert(`Network error: ${error.message}. Please check your connection.`, 'error');
                }
            } finally {
                setLoadingState(submitBtn, loading, btnText, false, false);
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const loading = document.getElementById('signupLoading');
            const btnText = document.getElementById('signupBtnText');
            
            // Show loading state
            setLoadingState(submitBtn, loading, btnText, true, true);
            clearAlerts();

            const formData = new FormData(e.target);
            const signupData = {
                username: formData.get('username').trim(),
                email: formData.get('email').trim(),
                fullName: formData.get('fullName').trim(),
                password: formData.get('password'),
                profilePicture: formData.get('profilePicture').trim() || null
            };

            console.log('Attempting signup with data:', { 
                username: signupData.username, 
                email: signupData.email,
                fullName: signupData.fullName 
            });

            try {
                const response = await fetch(`${API_BASE_URL}/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    credentials: 'include', // Include cookies for CORS
                    body: JSON.stringify(signupData)
                });

                console.log('Signup response status:', response.status);
                const result = await response.text();
                console.log('Signup response body:', result);

                if (response.ok) {
                    showAlert('Account created successfully! You can now log in.', 'success');
                    // Switch to login mode after successful signup
                    setTimeout(() => {
                        toggleMode();
                        signupForm.reset();
                    }, 2000);
                } else {
                    const errorMessage = result.includes('Error:') ? result : `Error: ${result}`;
                    showAlert(errorMessage || 'Signup failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Signup error details:', error);
                
                // More specific error messages
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showAlert('Cannot connect to server. Please check if the backend is running on http://localhost:8080', 'error');
                } else if (error.message.includes('CORS')) {
                    showAlert('CORS error: Please check your backend CORS configuration.', 'error');
                } else {
                    showAlert(`Network error: ${error.message}. Please check your connection.`, 'error');
                }
            } finally {
                setLoadingState(submitBtn, loading, btnText, false, true);
            }
        }

        function toggleMode() {
            isSignupMode = !isSignupMode;
            
            if (isSignupMode) {
                // Switch to signup mode
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                container.classList.add('max-w-lg');
                container.classList.remove('max-w-md');
                toggleText.textContent = 'Switch to Login';
                subtitle.textContent = 'Create your account to get started';
                dividerText.textContent = 'Already have an account?';
                switchLink.textContent = 'Switch to Login';
            } else {
                // Switch to login mode
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                container.classList.remove('max-w-lg');
                container.classList.add('max-w-md');
                toggleText.textContent = 'Switch to Signup';
                subtitle.textContent = 'Welcome back! Please sign in to your account';
                dividerText.textContent = 'Don\'t have an account?';
                switchLink.textContent = 'Switch to Signup';
            }
            
            clearAlerts();
        }

        function setLoadingState(button, loading, btnText, isLoading, isSignup) {
            if (isLoading) {
                button.disabled = true;
                loading.classList.remove('hidden');
                btnText.textContent = isSignup ? 'Creating Account...' : 'Signing In...';
            } else {
                button.disabled = false;
                loading.classList.add('hidden');
                btnText.textContent = isSignup ? 'Create Account' : 'Sign In';
            }
        }

        function showAlert(message, type) {
            clearAlerts();
            const alert = document.createElement('div');
            const isError = type === 'error';
            
            alert.className = `p-3 rounded-lg mb-5 text-sm animate-fade-in ${
                isError 
                    ? 'bg-red-50 text-red-700 border border-red-200' 
                    : 'bg-green-50 text-green-700 border border-green-200'
            }`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            
            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    clearAlerts();
                }, 5000);
            }
        }

        function clearAlerts() {
            alertContainer.innerHTML = '';
        }
    </script>
</body>
</html>